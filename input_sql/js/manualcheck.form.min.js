$(document).ready(function() {
    var session_parsedItems =0;
    var cur_items;
    var par_items;
    var total_rows;
    var cur_index = 0;
    var parsedItems = 0;
    var cur_items_count = 0;
    var grandtotal = 0;
    var existsDb = false;
    var emptyDb = false;
    var rec_id;
    var trid;
    var par_id;
    
    getNewData();
    
   
    function session_data(session_parsedItems){
        $.post("session_data.php", {
            method: "getdata",
            start: session_parsedItems,
            count: 10
            
        }, function(data, status) {
            session_parsedItems = parsedItems;
        })
    }
    function getNewData() {
       
        $.post("manual_check_data.php", {
            method: "getdata",
            start: parsedItems,
            count: 10
            
        }, function(data, status) {
            var dataset = eval(data)
            
            console.log("GetNewData : " + dataset[0].TotalRows + "Rows: " + dataset[0].Rows);
            if (dataset[0].Rows == null) {
                if (parsedItems == 0) {
                    emptyDb = true;
                    $("#leftcount").html("");
                    $("#errormsg").html("<center><p class='text-error'>* There are no records in manual_check table. *</p></center>");
                    $("div .bs-docs-currentrow table tbody").html("<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
                    $("div .bs-docs-candidates table tbody").html("<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
                } else {
                    emptyDb = false;
                    $("#errormsg").html("<center><p class='text-info'>* Reached the end of the manual_check table. *</p></center>");
                }
                if (existsDb == true) {
                    cur_index--;
                    console.log("cur_index = " + cur_index);
                }
            } else {
                existsDb = true;
                
                parsedItems += dataset[0].TotalRows;
                cur_items_count = dataset[0].TotalRows;
                grandtotal = dataset[0].GrandTotal;
                cur_index = 0;
                cur_items = dataset[0].Rows;
                printCurRow(cur_index);
                printSimilarRecords(cur_index);
                session_parsedItems = 0;
                session_data(session_parsedItems);
            }
        })
    }
   
    function printCurRow(index) {
        var currentIndex_div = "<div id='currentIndex'  >"+index+"</div>";
        var html;
        
        html += "<tr>";
        html += "<td><div id='currentIndex'  >"+index+"</div></td>";
        html += "<td>" + cur_items[index].id + "</td>";
        html += "<td>" + cur_items[index].name + "</td>";
        html += "<td>" + cur_items[index].surname + "</td>";
        html += "<td>" + cur_items[index].address + "</td>";
        html += "<td>" + cur_items[index].suburb + "</td>";
        html += "<td>" + cur_items[index].state + "</td>";
        html += "<td>" + cur_items[index].zip + "</td>";
        html += "<td>" + cur_items[index].mobile + "</td>";
        html += "<td>" + cur_items[index].alt_phone + "</td>";
        html += "<td>" + cur_items[index].home_phone + "</td>";
        html +='<td><button type="button" name="'+index+' " id="'+ cur_items[index].id +'" class="btnEditPar btn btn-primary">Edit</button></td>';
        html += "</tr>";
        $("div .bs-docs-currentrow table tbody").html(html);
        $("#errormsg").html("");
        var left = "<h5>" + grandtotal + " LEFT</h5>";
        
        $("#leftcount").html(left);
    }
    
    update_row();

    function update_row(){
       
        // $('button.btnDelete').on('click', function (e) {
        $(document).on( "click", ".btnDelete", function(e) {           
            e.preventDefault();
            $('#myModal').modal({
                remote: 'modal_data.php?p=' + this.id+'&par_id='+this.name
            });
            $('#myModal').modal('show');
            rec_id = this.id;
            par_id = this.name;
        });
        // $('button.btnEditPar').on('click', function (e) {
        $(document).on( "click", ".btnEditPar", function(e) {                
            e.preventDefault();
            $('#myModal2').modal({
                remote: 'modal_manual_data.php?p=' + this.id
            });
            $('#myModal2').modal('show');
            rec_id = this.id;
           
        });
        $('#btnDelteYes').click(function () {
            $.ajax({
    
                type: "POST",
                url: "save_modal_data.php?a=save",
                data: jQuery("#form1").serialize(),
                cache: false,
                success:  function(data){
                    //                    $("#"+trid).html(data).promise().done(function(){  
                            
                    $('#myModal').modal('hide');
                       
                    var index = $('#currentIndex').text(); 
                   
                    printSimilarRecords(index); 
                         
                //                    });   
                }
            });
        }); 
        $('#btnParEditYes').click(function () {
            $.ajax({
    
                type: "POST",
                url: "save_modal_manual_data.php?a=save",
                data: jQuery("#form2").serialize(),
                cache: false,
                success:  function(data){
                    // 
                    //                                     $("#"+trid).html(data).promise().done(function(){  
                    var index = $('#currentIndex').text();   
                    var dataparset = eval(data)   
                    par_items = dataparset[0].ParRows
                    $('#myModal2').modal('hide');
                    cur_items[index] = par_items[0];    
                    printCurRow(index); 
                    printSimilarRecords(index); 
                //                    });   
                }
            });
        }); 
   
    }

    function printSimilarRecords(index) {
        
       // $('#currentIndex').text(index);
       
        $.post("manual_check_data.php", {
            method: "getsimilar",
            id: cur_items[index].id
            
        }, function(data, status) {
            var dataset = eval(data);
            console.log("PrintSimilarRecords : " + dataset[0].TotalRows + "Rows: " + dataset[0].Rows);
            var html = "";
           
            for (var i = 0; i < dataset[0].TotalRows; i++) {
                var record = dataset[0].Rows[i];
                //                html += "<tr name="+index+" >";
                if(record.diff<5){
                    html += "<tr  style='background-color:rgb(" + (255 - i * 10) + "," + (5) + "," + (5) + ")'>";
                }
                else{
                    html += "<tr  style='background-color:rgb(" + (245 - i * 10) + "," + (245 - i * 10) + "," + (245 - i * 10) + ")'>";
                }
                html += "<td>" + (i + 1) + "</td>";
                html += "<td>" + record.name + "</td>";
                html += "<td>" + record.surname + "</td>";
                html += "<td>" + record.address + "</td>";
                html += "<td>" + record.suburb + "</td>";
                html += "<td>" + record.state + "</td>";
                html += "<td>" + record.zip + "</td>";
                html += "<td>" + record.mobile + "</td>";
                html += "<td>" + record.alt_phone + "</td>";
                html += "<td>" + record.home_phone + "</td>";
                html += "<td>" + record.diff + "</td>"; 
                html += '<td type="hidden"></td>';
                html +='<td> <button type="button" name="'+record.par_id+'" id="'+record.id+'" class="btnDelete btn btn-primary">Edit</button></td>';
               
                html += "</tr>"
            }
            $("div .bs-docs-candidates table tbody").html(html).promise().done(function(){
                //update_row(index);
                });
 
        });
    // session_data();
    }

    function processNextRow() {
        cur_index++;
        if (cur_index < cur_items_count) {
            printCurRow(cur_index);
            printSimilarRecords(cur_index);
        } else {
            getNewData();
        }
    }

    function processPrevRow() {
        cur_index--;
       
        if (cur_index >= 0) {
            printCurRow(cur_index);
            printSimilarRecords(cur_index);
        } else {
            parsedItems -= 10;
            if (parsedItems < 0) {
                parsedItems = 0
            }
            getNewData();
        }
    }

    function removeItemAndNext(index) {
        if (cur_items_count > 0) {
            parsedItems--;
            cur_items_count--;
            grandtotal--;
            cur_items.splice(cur_index, 1);
            cur_index--;
            processNextRow();
        }
    }
    $("#acceptButton").click(function() {
        $.post("manual_check_data.php", {
            method: "acceptrow",
            id: cur_items[cur_index].id
        }, function(data, status) {
            var dataset = eval(data)
            console.log("Accept : " + dataset[0].result + "Rows: " + dataset[0].Rows);
            if (dataset[0].result == "success") {
                removeItemAndNext(cur_index);
            } else {}
        })
    });
    $("#rejectButton").click(function() {
        $.post("manual_check_data.php", {
            method: "rejectrow",
            id: cur_items[cur_index].id
        }, function(data, status) {
            var dataset = eval(data);
            console.log("Reject : " + dataset[0].result + "Rows: " + dataset[0].Rows);
            if (dataset[0].result == "success") {
                removeItemAndNext(cur_index);
            } else {}
        })
    });
    $("#prevButton").click(function() {
        processPrevRow()
    });
    $("#nextButton").click(function() {
        processNextRow()
    });
    $("#undoButton").click(function() {
        $.post("undo_data.php", {
            method: "undo"
        // id: cur_items[cur_index].id
        }, function(data, status) {
            var dataset = eval(data);
            $("#undo_status").html(dataset[0].result);
        })
    });
    
    $("#deleteButton").click(function() {
        $.post("manual_check_data.php", {
            method: "deleterow",
            id: cur_items[cur_index].id
        }, function(data, status) {
            var dataset = eval(data);
            console.log("Delete : " + dataset[0].result + "Rows: " + dataset[0].Rows);
            if (dataset[0].result == "success") {
                removeItemAndNext(cur_index);
            } else {}
        })
    })
});